blueprint:
  name: HUE App rebuild automation (Enhanced)
  description: Controls lights based on motion and brightness with scene activation or dimming options.
  domain: automation
  source_url: https://github.com/dafloor/HUE_lights_template_rebuild/blob/main/blueprint  # Update URL if code changes

  input:
    motion_entity:
      name: Motion Sensor(s)  # Allow multiple sensors (see trigger)
      selector:
        entity:
          domain: binary_sensor
          device_class: motion
    brightness_entity:
      name: Brightness Sensor
      selector:
        entity:
          device_class: illuminance
    light_target:
      name: Lights to turn on/dim
      selector:
        target:
          entity:
            domain: light
    brightness_trigger:
      name: Minimum Brightness for Activation (lux)
      description: Lights will activate only if it's darker than this level.
      default: 50  # Increased default value
      selector:
        number:
          min: 0.0
          max: 1000.0
          unit_of_measurement: lx
          mode: slider
          step: 1.0
    dimming_enabled:  # New option for dimming
      name: Enable Dimming instead of Scene Activation
      default: false
      selector:
        boolean: {}
    dim_level:  # New option for dimming level
      name: Dimming Level (0-100%) when activated
      default: 50
      selector:
        number:
          min: 0.0
          max: 100.0
          unit_of_measurement: "%"
          mode: slider
          step: 1.0
          visible: !input 'dimming_enabled'  # Only visible if dimming enabled
    scene_name:
      name: Scene to Activate (if dimming not enabled)
      selector:
        entity:
          domain: scene
      visible: !input "dimming_enabled"  # Only visible if dimming not enabled
    no_motion_wait:
      name: Wait time after motion stops
      description: Time to leave lights on/dimmed after last motion is detected.
      default: 300
      selector:
        number:
          min: 0.0
          max: 36000.0
          unit_of_measurement: seconds
          mode: slider
          step: 10.0
    start_time:
      name: Start Time
      description: Time action should start
      default: '06:00:00'
      selector:
        time: {}
    end_time:
      name: End Time
      default: '23:00:00'
      description: Time action should stop
      selector:
        time: {}
    enable_automation:  # New option to enable/disable
      name: Enable Automation
      default: true
      selector:
        boolean: {}

  mode: restart
  max_exceeded: silent

  trigger:
    - platform: state  # Allow multiple sensors with OR logic (see condition)
      entity_id: "{{ range motion_entity | list }}"  # Iterate through all motion sensors
      from: 'off'
      to: 'on'

  condition:
    - condition: and
      conditions:
        - condition: numeric_state
          entity_id: !input 'brightness_entity'
          below: !input 'brightness_trigger'
        - condition: time
          after: !input 'start_time'
          before: !input 'end_time'
        - condition: state  # Check if automation is enabled
          entity_id: input.enable_automation
          state: 'on'

  action:
    - choose:  # Choose between scene activation or dimming
      - conditions: !input 'dimming_enabled'  # Activate scene if dimming not enabled
        sequence:
          - service: scene.turn_on
            target:
              entity_id: !input 'scene_name'
      - sequence:  # Dim lights if dimming enabled
          - service: light.turn_on
            target:
              entity_id: !input 'light_target'
          - service: light.set_brightness
            target:
              entity_id: !input 'light_target'
            data:
              brightness: !
